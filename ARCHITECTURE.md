# BookClub TMA - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

## –û–±–∑–æ—Ä

BookClub TMA - —ç—Ç–æ Telegram Mini App –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–Ω–∏–∂–Ω—ã–º –∫–ª—É–±–æ–º —Å —Å–∏—Å—Ç–µ–º–æ–π –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –∑–∞ –∫–Ω–∏–≥–∏.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

**Backend:**
- **NestJS** - Node.js —Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- **Prisma ORM** - –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- **PostgreSQL** - –û—Å–Ω–æ–≤–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **Redis** - –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
- **JWT** - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- **Telegram Bot API** - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram

**Frontend:**
- **Next.js 14** (App Router) - React —Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- **TypeScript** - –¢–∏–ø–∏–∑–∞—Ü–∏—è
- **Telegram Mini App SDK** - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram
- **CSS-in-JS** - –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è

**–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
- **Render** - –•–æ—Å—Ç–∏–Ω–≥ –∏ –¥–µ–ø–ª–æ–π
- **GitHub** - –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –û—Å–Ω–æ–≤–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏

```mermaid
erDiagram
    User {
        string id PK
        string tgUserId UK
        string name
        string username  
        string[] roles
        DateTime createdAt
    }
    
    Iteration {
        string id PK
        string name
        IterStatus status
        boolean isPublicVotes
        DateTime openedAt
        DateTime closedAt
        DateTime meetingDate
        DateTime createdAt
    }
    
    Book {
        string id PK
        string titleNorm
        string[] authorsNorm
        int year
        string isbn10
        string isbn13 UK
        string coverUrl
        string source
        json meta
        DateTime createdAt
    }
    
    Candidate {
        string id PK
        string bookId FK
        string addedByUserId FK
        string iterationId FK
        string reason
        DateTime createdAt
    }
    
    Vote {
        string id PK
        string iterationId FK
        string candidateId FK
        string userId FK
        DateTime createdAt
    }
    
    User ||--o{ Candidate : "–¥–æ–±–∞–≤–ª—è–µ—Ç"
    User ||--o{ Vote : "–≥–æ–ª–æ—Å—É–µ—Ç"
    Book ||--o{ Candidate : "—è–≤–ª—è–µ—Ç—Å—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–º"
    Iteration ||--o{ Candidate : "—Å–æ–¥–µ—Ä–∂–∏—Ç"
    Iteration ||--o{ Vote : "–ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≥–æ–ª–æ—Å–∞"
    Candidate ||--o{ Vote : "–ø–æ–ª—É—á–∞–µ—Ç –≥–æ–ª–æ—Å–∞"
```

### –°–æ—Å—Ç–æ—è–Ω–∏—è –∏—Ç–µ—Ä–∞—Ü–∏–∏

```mermaid
stateDiagram-v2
    [*] --> PLANNED : –ê–¥–º–∏–Ω —Å–æ–∑–¥–∞–µ—Ç
    PLANNED --> OPEN : –ê–¥–º–∏–Ω –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç
    OPEN --> CLOSED : –ê–¥–º–∏–Ω –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –∏–ª–∏ –¥–µ–¥–ª–∞–π–Ω
    CLOSED --> [*]
    
    PLANNED : üü° –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è<br/>–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–ª—è—Ç—å –∫–Ω–∏–≥–∏
    OPEN : üü¢ –û—Ç–∫—Ä—ã—Ç–∞<br/>–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –∫–Ω–∏–≥–∏ –∏ –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å  
    CLOSED : ‚ö´ –ó–∞–∫—Ä—ã—Ç–∞<br/>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—ä—è–≤–ª–µ–Ω—ã
```

## –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã

1. **–°–æ–∑–¥–∞–Ω–∏–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏ (–ê–¥–º–∏–Ω)**
   - –ê–¥–º–∏–Ω —Å–æ–∑–¥–∞–µ—Ç –∏—Ç–µ—Ä–∞—Ü–∏—é —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `PLANNED`
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –¥–µ–¥–ª–∞–π–Ω
   - –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –∏—Ç–µ—Ä–∞—Ü–∏—é (—Å—Ç–∞—Ç—É—Å ‚Üí `OPEN`)

2. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–∏–≥ (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)**
   - –ü–æ–∏—Å–∫ –∫–Ω–∏–≥ —á–µ—Ä–µ–∑ Google Books API (—Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∫–Ω–∏–≥–∏ –∫–∞–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ ISBN13

3. **–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)**
   - –û–¥–∏–Ω –≥–æ–ª–æ—Å –Ω–∞ –∏—Ç–µ—Ä–∞—Ü–∏—é –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ–π –≤—ã–±–æ—Ä
   - –ü–æ–¥—Å—á–µ—Ç –≥–æ–ª–æ—Å–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

4. **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏ (–ê–¥–º–∏–Ω/–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)**
   - –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –¥–µ–¥–ª–∞–π–Ω—É –∏–ª–∏ –≤—Ä—É—á–Ω—É—é
   - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –≥–æ–ª–æ—Å–æ–≤
   - –ê–Ω–æ–Ω—Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ Telegram –∫–∞–Ω–∞–ª

### –ü—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø–∞

**–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã (`admin` —Ä–æ–ª—å):**
- –°–æ–∑–¥–∞–Ω–∏–µ/–æ—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –∏—Ç–µ—Ä–∞—Ü–∏–π
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–µ–¥–ª–∞–π–Ω–æ–≤
- –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:**
- –ü–æ–∏—Å–∫ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–∏–≥
- –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
- –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ –∏ –∏—Å—Ç–æ—Ä–∏–∏

## API Design

### RESTful –ø—Ä–∏–Ω—Ü–∏–ø—ã

```
GET    /iterations/current      # –¢–µ–∫—É—â–∞—è –æ—Ç–∫—Ä—ã—Ç–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è
POST   /iterations             # –°–æ–∑–¥–∞–Ω–∏–µ (admin)
PATCH  /iterations/:id/open    # –û—Ç–∫—Ä—ã—Ç–∏–µ (admin)
PATCH  /iterations/:id/close   # –ó–∞–∫—Ä—ã—Ç–∏–µ (admin)

GET    /books/search?q=query   # –ü–æ–∏—Å–∫ –∫–Ω–∏–≥
POST   /candidates             # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–∏–≥–∏
DELETE /candidates/:id         # –£–¥–∞–ª–µ–Ω–∏–µ —Å–≤–æ–µ–π –∫–Ω–∏–≥–∏

POST   /votes                  # –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
POST   /auth/telegram/init     # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
```

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

1. **Telegram Mini App Auth:**
   - –í–∞–ª–∏–¥–∞—Ü–∏—è `initData` –æ—Ç Telegram
   - –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –í—ã–¥–∞—á–∞ JWT —Ç–æ–∫–µ–Ω–∞

2. **JWT Security:**
   - Payload: `{ uid, tg, r }` (user id, telegram id, roles)
   - –í—Ä–µ–º—è –∂–∏–∑–Ω–∏: 7 –¥–Ω–µ–π
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∞–∂–¥–æ–º –∑–∞—â–∏—â–µ–Ω–Ω–æ–º —ç–Ω–¥–ø–æ–∏–Ω—Ç–µ

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### Google Books API
- –ü–æ–∏—Å–∫ –∫–Ω–∏–≥ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é/–∞–≤—Ç–æ—Ä—É
- –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (–æ–±–ª–æ–∂–∫–∏, ISBN, –≥–æ–¥)
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Redis –Ω–∞ 24 —á–∞—Å–∞

### Telegram Bot API
- –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–Ω–æ–Ω—Å–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –∫–∞–Ω–∞–ª
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ–±–ª–æ–∂–∫–∞–º–∏ –∫–Ω–∏–≥
- Inline –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

### Redis Caching
- –ö–µ—à –ø–æ–∏—Å–∫–∞ –∫–Ω–∏–≥: `gbooks:{base64(query)}`
- TTL: 24 —á–∞—Å–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —á–µ—Ä–µ–∑ API

## –î–µ–ø–ª–æ–π–º–µ–Ω—Ç

### Render.com
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –ø–æ –∫–æ–º–º–∏—Ç—É –≤ main
- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Render Dashboard
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ Prisma

### Database Migrations
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Prisma
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ: `prisma migrate deploy`
- –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ PostgreSQL –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏
```typescript
console.log('[CONTROLLER][ACTION] details', data);
```

**–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:**
- `[AUTH]` - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- `[BOOKS]` - –ü–æ–∏—Å–∫ –∫–Ω–∏–≥  
- `[CANDIDATE]` - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –∫–Ω–∏–≥
- `[VOTE]` - –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
- `[ADMIN]` - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
- `[API]` - HTTP –∑–∞–ø—Ä–æ—Å—ã

### –ú–µ—Ç—Ä–∏–∫–∏
- HTTP —Å—Ç–∞—Ç—É—Å –∫–æ–¥—ã –∏ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –û—à–∏–±–∫–∏ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –î–∞–Ω–Ω—ã–µ
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- SQL Injection –∑–∞—â–∏—Ç–∞ (Prisma ORM)
- XSS –∑–∞—â–∏—Ç–∞ (CSP headers)

### API
- Rate limiting —á–µ—Ä–µ–∑ Render
- CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è Telegram
- JWT —Ç–æ–∫–µ–Ω—ã —Å –∫–æ—Ä–æ—Ç–∫–∏–º TTL

### Telegram
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏ initData
- –í–∞–ª–∏–¥–∞—Ü–∏—è Telegram –ø–æ–¥–ø–∏—Å–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ –¥–∞–Ω–Ω—ã—Ö (1 —á–∞—Å)

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- Redis –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–Ω–∏–≥
- Browser cache –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
- CDN —á–µ—Ä–µ–∑ Render

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- Prisma query optimization
- –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- Lazy loading –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (Next.js)

### –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
- Stateless —Å–µ—Ä–≤–∏—Å (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ)
- Separated concerns (–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã/—Å–µ—Ä–≤–∏—Å—ã)
- Database connection pooling

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
   - –°–∏—Å—Ç–µ–º–∞ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ –∫–Ω–∏–≥
   - –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º
   - –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –¥–µ–¥–ª–∞–π–Ω–∞—Ö

2. **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ:**
   - GraphQL API
   - Real-time updates (WebSockets)
   - Mobile –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

3. **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞:**
   - Dashboard –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∂–∞–Ω—Ä–æ–≤
   - –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
